import * as vscode from 'vscode';
import { OEUnitTestProvider } from './testProvider';
import { OEUnitTestRunner } from './testRunner';

export function activate(context: vscode.ExtensionContext) {
    console.log('OEUnit Test Explorer extension is now active');

    const testProvider = new OEUnitTestProvider();
    const testRunner = new OEUnitTestRunner();

    // Register tree data provider
    const treeView = vscode.window.createTreeView('oeunitTestExplorer', {
        treeDataProvider: testProvider,
        showCollapseAll: true
    });

    context.subscriptions.push(treeView);

    // Register commands
    context.subscriptions.push(
        vscode.commands.registerCommand('oeunit.refreshTests', () => {
            testProvider.refresh();
        })
    );

    context.subscriptions.push(
        vscode.commands.registerCommand('oeunit.runAllTests', async () => {
            const tests = await testProvider.getAllTests();
            await testRunner.runTests(tests);
            testProvider.refresh();
        })
    );

    context.subscriptions.push(
        vscode.commands.registerCommand('oeunit.runTest', async (testItem: any) => {
            await testRunner.runTest(testItem);
            testProvider.refresh();
        })
    );

    context.subscriptions.push(
        vscode.commands.registerCommand('oeunit.debugTest', async (testItem: any) => {
            vscode.window.showInformationMessage('Debug functionality coming soon!');
        })
    );

    // Auto-refresh on file changes
    const watcher = vscode.workspace.createFileSystemWatcher('**/*.cls');
    context.subscriptions.push(watcher);
    
    watcher.onDidChange(() => testProvider.refresh());
    watcher.onDidCreate(() => testProvider.refresh());
    watcher.onDidDelete(() => testProvider.refresh());

    // Initial load
    testProvider.refresh();
}

export function deactivate() {}
